---
title: "machinelearning"
author: "kmok23"
date: "November 12, 2015"
output: html_document
---

```{r, cache=TRUE}
# Load data
library(RCurl)
if (!exists("trainraw")) {  # Checks if data has been populated
    trainurl <- "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv"
#    download.file(trainurl, "pml-training.csv", method = "curl")
    trainraw <- read.csv("pml-training.csv")
}
if (!exists("testraw")) {  # Checks if data has been populated
    testurl <- "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv"
#    download.file(testurl, "pml-testing.csv", method = "curl")
    testraw <- read.csv("pml-testing.csv")
}

missingVals <- data.frame(Variable = character(),
                          Missing = integer(),
                          stringsAsFactors = FALSE)
for (i in 1:dim(trainraw)[2]) {
    # Take name of variable
    missingVals[i, 1] <- names(trainraw)[i]
    # Count empty values
    missingVals[i, 2] <- sum(trainraw[, i] == "", na.rm = TRUE)
    # Count NA values
    missingVals[i, 2] <- missingVals[i, 2] + sum(is.na(trainraw[, i]))
}

missingValTest <- data.frame(Variable = character(),
                          Missing = integer(),
                          stringsAsFactors = FALSE)
for (i in 1:dim(testraw)[2]) {
    # Take name of variable
    missingValTest[i, 1] <- names(testraw)[i]
    # Count empty values
    missingValTest[i, 2] <- sum(testraw[, i] == "", na.rm = TRUE)
    # Count NA values
    missingValTest[i, 2] <- missingValTest[i, 2] + sum(is.na(testraw[, i]))
}

# Remove variables with missing data
newtrain <- trainraw[, which(missingVals[, 2] == 0)]
varToRemove <- names(newtrain) %in% c("X", "user_name", "raw_timestamp_part_1",
                                      "raw_timestamp_part_2", "cvtd_timestamp",
                                      "new_window", "num_window")
traindata <- newtrain[!varToRemove]
library(caret)
corMatrix <- cor(traindata[,1:52])
highCor <- findCorrelation(corMatrix, cutoff = 0.75)
print(highCor)

# Split the training set into 70/30 training-validation sets
inTrain <- createDataPartition(traindata$classe, p = .7, list = FALSE)
trainMod <- traindata[inTrain,]
validMod <- traindata[-inTrain,]

library(randomForest)
modelFitRF <- randomForest(classe ~ ., data = trainMod)
validationPredRF <- predict(modelFitRF, validMod)
confusionMatrix(validationPredRF, validMod$classe)

# Perform prediction
finalPrediction <- predict(modelFitRF, testraw, type = "class")

pml_write_files = function(x) {
    n = length(x)
    for(i in 1:n) {
        filename = paste0("problem_id_",i,".txt")
        write.table(x[i], file = filename, quote = FALSE, row.names = FALSE,
                    col.names = FALSE)
    }
}
pml_write_files(finalPrediction)
```

